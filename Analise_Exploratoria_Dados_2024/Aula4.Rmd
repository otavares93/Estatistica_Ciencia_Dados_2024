---
title: "An√°lise de dados criminais - Teste de Hip√≥tese"
author: "Otto Tavares"
date: "2023-03-21"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Introdu√ß√£o

```{r importando bibliotecas, echo = TRUE}
library(tidyverse)
library(purrr)
library(dlookr)
library(summarytools)
library(readxl)
library(knitr)
library(data.table)
library(ggpubr)
library(corrplot)
library(rcompanion)
```


```{r importando dados, echo = FALSE}
crimes <- readr::read_csv2("/Users/ottotavares/Library/Mobile Documents/com~apple~CloudDocs/Documents/infnet/Estatistica_Ciencia_Dados_2024/dados_auxiliares/BaseDPEvolucaoMensalCisp.csv", locale = readr::locale(encoding = "latin1"))
```
# Limpando os dados e realizando diagn√≥stico

```{r filtrando os dados e descrevendo a base, echo = FALSE}

crimes.aisp <- crimes %>% dplyr::select(CISP, mes, ano,  AISP,  RISP, roubo_transeunte, roubo_celular, posse_drogas) %>% dplyr::mutate(mes.ano = as.IDate(paste("01", mes, ano, sep = "-"), format = "%d-%m-%Y")) %>% dplyr::filter(mes.ano %in% c(as.IDate("01-12-2019",format = "%d-%m-%Y"), as.IDate("01-12-2020",format = "%d-%m-%Y"), as.IDate("01-12-2021",format = "%d-%m-%Y") ,as.IDate("01-12-2022",format = "%d-%m-%Y"))) %>% dplyr::group_by(AISP, mes.ano) %>% dplyr::summarise(roubo_transeunte = sum(roubo_transeunte), roubo_celular = sum(roubo_celular), posse_drogas = sum(posse_drogas))

crimes.aisp <- crimes.aisp %>% dplyr::left_join(crimes %>% dplyr::select(AISP, Regiao, mes, ano) %>% 
dplyr::mutate(mes.ano = as.IDate(paste("01", mes, ano, sep = "-"), format = "%d-%m-%Y")) %>% dplyr::filter(mes.ano %in% c(as.IDate("01-12-2019",format = "%d-%m-%Y"), as.IDate("01-12-2020",format = "%d-%m-%Y"), as.IDate("01-12-2021",format = "%d-%m-%Y") ,as.IDate("01-12-2022",format = "%d-%m-%Y"))) %>% dplyr::distinct(AISP, mes.ano, Regiao), by = c("AISP" = "AISP", "mes.ano"="mes.ano"))

crimes.aisp %>% dlookr::diagnose()

```

# Descri√ß√£o via boxplot e tabelas de conting√™ncia

```{r descrevendo a base com box plot roubo transeunte, echo = FALSE}

crimes.aisp %>% ggplot(aes(x = as.factor(AISP), color = Regiao)) + geom_boxplot(aes(y = roubo_transeunte)) + xlab('Batalh√µes') + ylab('Roubo √† Transeunte')
```

```{r descrevendo a base com box plot roubo celular, echo = FALSE}

crimes.aisp %>% ggplot(aes(x = as.factor(AISP), color = Regiao)) + geom_boxplot(aes(y = roubo_celular)) + xlab('Batalh√µes') + ylab('Roubo de Celular')
```

```{r descrevendo a base com box plot roubo transeunte por regiao, echo = FALSE}

crimes.aisp %>% ggplot(aes(x = as.factor(Regiao))) + geom_violin(aes(y = roubo_transeunte)) + xlab('Batalh√µes') + ylab('Roubo √† Transeunte') + facet_wrap(~mes.ano)

```


```{r tabelas de conting√™ncia, echo = FALSE}

summarytools::ctable(x = crimes.aisp$mes.ano, 
       y = crimes.aisp$Regiao, 
       prop = "t") 

```
```{r tabelas de conting√™ncia batalhao vs regiao, echo = FALSE}

#summarytools::ctable(x = factor(crimes.aisp$AISP), 
#       y = crimes.aisp$Regiao,
#       prop = "t") 

```


# Construindo os histogramas da Aula 1

```{r filtrando os dados e visualizando dists., echo = FALSE}

fd <- function(x) {
  n <-length(x)
  return((2*IQR(x))/n^(1/3))
}

sr <- function(x) {
  n <-length(x)
  return((3.49*sd(x))/n^(1/3))
}

#crimes.aisp <- crimes %>% dplyr::select(CISP, mes, ano,  AISP,  RISP, roubo_transeunte) %>% dplyr::mutate(mes.ano = as.IDate(paste("01", mes, ano, sep = "-"), format = "%d-%m-%Y")) %>% dplyr::group_by(AISP, mes.ano) %>% dplyr::summarise(roubo_transeunte = sum(roubo_transeunte))

#Calculando os histogramas para o mesmo evento em diferentes instantes de tempo

crimes.aisp %>% ggplot(aes(x = roubo_transeunte)) + geom_histogram(aes(y = after_stat(density)), binwidth=fd, fill = 'lightblue') + facet_wrap(~mes.ano)
```

# Aplicando estimativa de densidade via kernel, atrav√©s do kernel de epanechnikov

```{r filtrando os dados e visualizando dists. com kernel, echo = FALSE}
#Calculando os histogramas para o mesmo evento em diferentes instantes de tempo

crimes.aisp %>% ggplot(aes(x = roubo_transeunte)) + geom_histogram(aes(y = after_stat(density)), binwidth=fd, fill = 'lightblue') + geom_density(kernel = 'epanechnikov')+ facet_wrap(~mes.ano)
```


# Calculando a distribui√ß√£o acumulada emp√≠rica do fen√¥meno observado

```{r filtrando os dados e visualizando dists. acumuladas, echo = FALSE}

crimes.aisp %>% ggplot(aes(x = roubo_transeunte)) +stat_ecdf(geom = "step") + geom_vline(data = crimes.aisp %>% dplyr::group_by(mes.ano) %>% dplyr::summarize(roubo_transeunte_md = median(roubo_transeunte)), aes(xintercept=roubo_transeunte_md)) + facet_wrap(~mes.ano) + theme_bw()
```

```{r calculando as medianas, echo = FALSE}

crimes.aisp %>% dplyr::group_by(mes.ano) %>% dplyr::summarize(roubo_transeunte_md = median(roubo_transeunte))
```


# Calculando a dispers√£o e as correla√ß√µes de Pearson

```{r calculando dispersao para as duas datas, echo = FALSE}

crimes.aisp %>% ggplot(aes(x = roubo_transeunte, y = roubo_celular)) +geom_point() + facet_wrap(~mes.ano) + stat_cor(method="pearson") + xlab('Roubo a Transeunte') + ylab('Roubo de Celular')
```

# Calculando a dispers√£o e as correla√ß√µes de Pearson e de Spearman

## Pearson

```{r calculando dispersao para an√°lise de pearson em rela√ß√£o n√£o linear, echo = FALSE}

crimes.aisp %>% ggplot(aes(x = roubo_transeunte, y = posse_drogas)) +geom_point() + facet_wrap(~mes.ano) + stat_cor(method="pearson") + xlab('Roubo a Transeunte') + ylab('Posse de Drogas') + geom_smooth(method = "lm")
```

## Spearman

```{r calculando dispersao para an√°lise de separman em rela√ß√£o n√£o linear, echo = FALSE}

crimes.aisp %>% ggplot(aes(x = roubo_transeunte, y = posse_drogas)) +geom_point() + facet_wrap(~mes.ano) + stat_cor(method="spearman") + xlab('Roubo a Transeunte') + ylab('Posse de Drogas') + geom_smooth()
```



```{r analise temporal de roubo a transeunte vs roubo celular para o estado, echo = FALSE}

crimes %>% dplyr::select(CISP, mes, ano,  AISP,  RISP, roubo_transeunte, roubo_celular) %>% dplyr::mutate(mes.ano = as.IDate(paste("01", mes, ano, sep = "-"), format = "%d-%m-%Y")) %>% dplyr::group_by(mes.ano) %>% dplyr::summarise(roubo_transeunte = sum(roubo_transeunte), roubo_celular = sum(roubo_celular)) %>% dplyr::filter(mes.ano > as.IDate("01-01-2019",format = "%d-%m-%Y")) %>% ggplot(aes(x = mes.ano)) + geom_line(aes(y = roubo_transeunte, color = "Roubo Transeunte")) + geom_point(data = crimes.aisp %>% dplyr::group_by(mes.ano) %>% dplyr::summarise(roubo_transeunte = sum(roubo_transeunte), roubo_celular = sum(roubo_celular)), aes(y = roubo_transeunte, color = "Roubo Transeunte")) + geom_line(aes(y = roubo_celular, color = "Roubo Celular")) + geom_point(data = crimes.aisp  %>% dplyr::group_by(mes.ano) %>% dplyr::summarise(roubo_transeunte = sum(roubo_transeunte), roubo_celular = sum(roubo_celular)), aes(y = roubo_celular, color = "Roubo Celular")) + ylab("# de Roubos (Transeuntes e Celulares)") + xlab("Horizonte Temporal") + labs(title = "Evolu√ß√£o temporal de roubos no Estado do Rio de Janeiro") + theme_bw()

```


```{r analise temporal de roubo a transeunte vs roubo celular para um dado batalhao, echo = FALSE}

crimes %>% dplyr::select(CISP, mes, ano,  AISP,  RISP, roubo_transeunte, roubo_celular) %>% dplyr::mutate(mes.ano = as.IDate(paste("01", mes, ano, sep = "-"), format = "%d-%m-%Y")) %>% dplyr::group_by(AISP, mes.ano) %>% dplyr::summarise(roubo_transeunte = sum(roubo_transeunte), roubo_celular = sum(roubo_celular)) %>% dplyr::filter(mes.ano > as.IDate("01-01-2019",format = "%d-%m-%Y") & AISP == 15) %>% ggplot(aes(x = mes.ano)) + geom_line(aes(y = roubo_transeunte, color = "Roubo Transeunte")) + geom_point(data = crimes.aisp %>% dplyr::filter(AISP == 15), aes(y = roubo_transeunte, color = "Roubo Transeunte")) + geom_line(aes(y = roubo_celular, color = "Roubo Celular")) + geom_point(data = crimes.aisp %>% dplyr::filter(AISP == 15), aes(y = roubo_celular, color = "Roubo Celular")) + ylab("# de Roubos (Transeuntes e Celulares)") + xlab("Horizonte Temporal") + labs(title = "Evolu√ß√£o temporal para um batalh√£o selecionado (AISP = 15)") + theme_bw()

```



# Calculando a dispers√£o e as correla√ß√µes

```{r calculando corrplot pearson, echo = FALSE}

crimes %>% dplyr::filter(mes_ano == "2022m12") %>% dplyr::select(roubo_veiculo, roubo_transeunte) %>% cor(., method = "pearson") %>% corrplot(., title = 'Pearson')

```


```{r calculando corrplot spearman, echo = FALSE}

crimes %>% dplyr::filter(mes_ano == "2022m12") %>% dplyr::select(roubo_veiculo, roubo_transeunte) %>% cor(., method = "spearman") %>% corrplot(., title = 'Spearman')

```

# Realizando o teste de Hip√≥tese (H√° evid√™ncia estat√≠stica na queda de roubo a transeunte ap√≥s a pandemia?) 

## Teste de Shapiro Wilk (para checar normalidade) nas amostras pr√© e p√≥s pandemia

A hip√≥tese nula aqui √©: A distribui√ß√£o de roubos a transeunte por batalh√£o segue distribui√ß√£o normal no m√™s selecionado para representar o pr√© pandemia.

A hip√≥tese alternativa: A distribui√ß√£o de roubos a transeunte por batalh√£o n√£o segue distribui√ß√£o normal no m√™s selecionado para representar o pr√© pandemia.

### Pr√© Pandemia
```{r shapiro wilk pre pandemia, echo = FALSE}

pre.pandemia <- crimes.aisp %>% dplyr::filter(mes.ano %in% as.IDate("01-12-2019",format = "%d-%m-%Y")) %>% dplyr::select(roubo_transeunte) 
shapiro.test(pre.pandemia$roubo_transeunte)

```

### Realizando o QQ-Plot do pr√© pandemia para ilustrar sua utiliza√ß√£o

```{r qqplot pre pandemia, echo = FALSE}

qqnorm(pre.pandemia$roubo_transeunte)

```

### P√≥s Pandemia (Primeiro ano de Pandemia - 01/12/2020)

A hip√≥tese nula aqui √©: A distribui√ß√£o de roubos a transeunte por batalh√£o segue distribui√ß√£o normal no m√™s selecionado para representar o p√≥s pandemia.

A hip√≥tese alternativa: A distribui√ß√£o de roubos a transeunte por batalh√£o n√£o segue distribui√ß√£o normal no m√™s selecionado para representar o p√≥s pandemia.

```{r shapiro wilk pos pandemia (primeiro ano), echo = FALSE}

pos.pandemia <- crimes.aisp %>% dplyr::filter(mes.ano %in% as.IDate("01-12-2020",format = "%d-%m-%Y")) %>% dplyr::select(roubo_transeunte)
shapiro.test(pos.pandemia$roubo_transeunte)
```

### Realizando o QQ-Plot do p√≥s pandemia para ilustrar sua utiliza√ß√£o

```{r qqplot pos pandemia, echo = FALSE}

qqnorm(pos.pandemia$roubo_transeunte)

```

### Teste de Wilcoxon para checar o pareamento - (Pr√© vs. Primeiro ano de Pandemia - 01/12/2020)

Realizado o teste de Wilcoxon para checar o pareamento entre as distribui√ß√µes de roubo a transeunte do pr√© e do p√≥s pandemia.

A hip√≥tese nula aqui √©: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© igual a zero.

A hip√≥tese alternativa: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s n√£o √© igual a zero.

```{r wilcox pos pandemia (primeiro ano), echo = FALSE}
wilcox.test(pre.pandemia$roubo_transeunte, pos.pandemia$roubo_transeunte, paired = T, exact = F)
```

### Teste de Wilcoxon para checar o pareamento (Maior que) - (Pr√© vs. Primeiro ano de Pandemia - 01/12/2020)

A hip√≥tese nula aqui √©: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© igual a zero.

A hip√≥tese alternativa: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© maior do que zero.

```{r wilcox pos pandemia maior que (primeiro ano), echo = FALSE}
wilcox.test(pre.pandemia$roubo_transeunte, pos.pandemia$roubo_transeunte, paired = T, exact = F, alternative = "greater")
```

### Teste de Wilcoxon para checar o pareamento (Menor que) - (Pr√© vs. Primeiro ano de Pandemia - 01/12/2020)

A hip√≥tese nula aqui √©: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© igual a zero.

A hip√≥tese alternativa: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© menor do que zero.

```{r wilcox pos pandemia menor que (primeiro ano), echo = FALSE}
wilcox.test(pre.pandemia$roubo_transeunte, pos.pandemia$roubo_transeunte, paired = T, exact = F, alternative = "less")
```


### P√≥s Pandemia (Segundo ano de Pandemia - 01/12/2021)

A hip√≥tese nula aqui √©: A distribui√ß√£o de roubos a transeunte por batalh√£o segue distribui√ß√£o normal no m√™s selecionado para representar o p√≥s pandemia.

A hip√≥tese alternativa: A distribui√ß√£o de roubos a transeunte por batalh√£o n√£o segue distribui√ß√£o normal no m√™s selecionado para representar o p√≥s pandemia.

```{r shapiro wilk pos pandemia (segundo ano), echo = FALSE}

pos.pandemia <- crimes.aisp %>% dplyr::filter(mes.ano %in% as.IDate("01-12-2021",format = "%d-%m-%Y")) %>% dplyr::select(roubo_transeunte)
shapiro.test(pos.pandemia$roubo_transeunte)
```

### Teste de Wilcoxon para checar o pareamento - (Pr√© vs. Segundo ano de Pandemia - 01/12/2021)

Realizado o teste de Wilcoxon para checar o pareamento entre as distribui√ß√µes de roubo a transeunte do pr√© e do p√≥s pandemia.

A hip√≥tese nula aqui √©: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© igual a zero.

A hip√≥tese alternativa: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s n√£o √© igual a zero.

```{r wilcox pos pandemia (segundo ano), echo = FALSE}
wilcox.test(pre.pandemia$roubo_transeunte, pos.pandemia$roubo_transeunte, paired = T, exact = F)
```

### Teste de Wilcoxon para checar o pareamento (Maior que) - (Pr√© vs. Segundo ano de Pandemia - 01/12/2021)

A hip√≥tese nula aqui √©: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© igual a zero.

A hip√≥tese alternativa: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© maior do que zero.

```{r wilcox pos pandemia maior que (segundo ano), echo = FALSE}
wilcox.test(pre.pandemia$roubo_transeunte, pos.pandemia$roubo_transeunte, paired = T, exact = F, alternative = "greater")
```

### Teste de Wilcoxon para checar o pareamento (Menor que) - (Pr√© vs. Segundo ano de Pandemia - 01/12/2021)

A hip√≥tese nula aqui √©: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© igual a zero.

A hip√≥tese alternativa: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© menor do que zero.

```{r wilcox pos pandemia menor que (segundo ano), echo = FALSE}
wilcox.test(pre.pandemia$roubo_transeunte, pos.pandemia$roubo_transeunte, paired = T, exact = F, alternative = "less")
```

### P√≥s Pandemia (Terceiro ano de Pandemia - 01/12/2022)

A hip√≥tese nula aqui √©: A distribui√ß√£o de roubos a transeunte por batalh√£o segue distribui√ß√£o normal no m√™s selecionado para representar o p√≥s pandemia.

A hip√≥tese alternativa: A distribui√ß√£o de roubos a transeunte por batalh√£o n√£o segue distribui√ß√£o normal no m√™s selecionado para representar o p√≥s pandemia.

```{r shapiro wilk pos pandemia (terceiro ano), echo = FALSE}

pos.pandemia <- crimes.aisp %>% dplyr::filter(mes.ano %in% as.IDate("01-12-2022",format = "%d-%m-%Y")) %>% dplyr::select(roubo_transeunte)
shapiro.test(pos.pandemia$roubo_transeunte)
```

### Teste de Wilcoxon para checar o pareamento (Pr√© vs. Terceiro ano de Pandemia - 01/12/2022)

Realizado o teste de Wilcoxon para checar o pareamento entre as distribui√ß√µes de roubo a transeunte do pr√© e do p√≥s pandemia.

A hip√≥tese nula aqui √©: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© igual a zero.

A hip√≥tese alternativa: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s n√£o √© igual a zero.

```{r wilcox pos pandemia (terceiro ano), echo = FALSE}
wilcox.test(pre.pandemia$roubo_transeunte, pos.pandemia$roubo_transeunte, paired = T, exact = F)
```

### Teste de Wilcoxon para checar o pareamento (Maior que) - (Pr√© vs. Terceiro ano de Pandemia - 01/12/2022)

A hip√≥tese nula aqui √©: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© igual a zero.

A hip√≥tese alternativa: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© maior do que zero.

```{r wilcox pos pandemia maior que (terceiro ano), echo = FALSE}
wilcox.test(pre.pandemia$roubo_transeunte, pos.pandemia$roubo_transeunte, paired = T, exact = F, alternative = "greater")
```

### Teste de Wilcoxon para checar o pareamento (Menor que) - (Pr√© vs. Terceiro ano de Pandemia - 01/12/2022)

A hip√≥tese nula aqui √©: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© igual a zero.

A hip√≥tese alternativa: A mediana das diferen√ßas (pr√© - p√≥s) entre as distribui√ß√µes de roubos a transeunte pr√© e p√≥s √© menor do que zero.

```{r wilcox pos pandemia menor que (terceiro ano), echo = FALSE}
wilcox.test(pre.pandemia$roubo_transeunte, pos.pandemia$roubo_transeunte, paired = T, exact = F, alternative = "less")
```


# (Extra) Realizando um teste de hip√≥tese b√°sico para refor√ßar o conceito

* Um gerente da ind√∫stria de telefonia acha que a conta mensal de telefone celular dos clientes em m√©dia acima de R$ 52 por m√™s. 

* A empresa deseja testar esta afirma√ß√£o. (Suponha que o n√≠vel de signific√¢ncia √© de 10%)
        
	ùêª_0: ùúÉ= 52 
	ùêª_1: ùúÉ> 52
	
## Gerando amostras artificiais extra√≠das de uma Normal

Na vida real coletar√≠amos amostras para testar essa hip√≥tese. Aqui ilustramos dois casos, dentre os quais o primeiro sup√µe que coletamos uma amostra com m√©dia acima de 52, enquanto o segundo faz a suposi√ß√£o de que a amostra coletada tem m√©dia inferior a 52

### Primeira amostra (Com m√©dia acima de 52)
```{r criando amostra cel acima, echo = FALSE}

cel.acima <- rnorm(5000, mean = 55, sd = 1)
```

### Segunda amostra (Com m√©dia abaixo de 52)

```{r criando amostra cel abaixo, echo = FALSE}

cel.abaixo <- rnorm(5000, mean = 45, sd = 1)
```

### Teste para a primeira amostra (Com m√©dia acima de 52)

```{r teste cel acima, echo = FALSE}

t.test(cel.acima, mu = 52, alternative = 'greater', conf.level = 0.9)

```

### Teste para a segunda amostra (Com m√©dia abaixo de 52)

```{r test cel abaixo, echo = FALSE}

t.test(cel.abaixo, mu = 52, alternative = 'greater', conf.level = 0.9)
```

